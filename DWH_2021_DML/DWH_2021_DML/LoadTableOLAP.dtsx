<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="7/18/2021 9:54:37 PM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="DESKTOP-NU9LQBU"
  DTS:CreatorName="DESKTOP-NU9LQBU\User"
  DTS:DTSID="{617ADF48-1363-405B-AD68-0AD0FD720CD8}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.2000.128"
  DTS:LocaleID="1049"
  DTS:ObjectName="LoadTableOLAP"
  DTS:PackageType="5"
  DTS:VersionBuild="15"
  DTS:VersionGUID="{DC825515-51C5-422A-847D-0536A811B1C8}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:Variables />
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\LoadOLAP"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Задача &quot;Выполнение SQL&quot;"
      DTS:DTSID="{40E9B1B0-2238-4078-9553-695F1DCB0088}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="LoadOLAP"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; SQL Server 2019; © 2019 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{02D516E0-FB85-4A98-9625-5E611F56EDD4}"
          SQLTask:BypassPrepare="False"
          SQLTask:SqlStatementSource="&#xA;&#xA;&#xA;&#xA;--CREATE TABLE [dbo].[FactConvertLeadToDeal](&#xA;--&#x9;[Lead_ID] [int] NOT NULL ,&#xA;--&#x9;[CreatedDate] [date] NULL FOREIGN KEY REFERENCES [dbo].[CalendarDay] ([CreatedDate]),&#xA;--&#x9;[CustomerID] [int] NOT NULL FOREIGN KEY REFERENCES [dbo].[Customers] (ID),&#xA;--&#x9;[RegionID] [int] NULL FOREIGN KEY REFERENCES [dbo].[Region] (ID),&#xA;--&#x9;[StatusID] [int] NOT NULL FOREIGN KEY REFERENCES [dbo].[Status] (ID),&#xA;--&#x9;[SourceID] [int] NOT NULL FOREIGN KEY REFERENCES [dbo].[Source] (ID),&#xA;--&#x9;[Deal_ID] [int] NULL,&#xA;--&#x9;[Deal_DateCreate] [date] NULL,&#xA;--&#x9;[Deal_DateClose] [date] NULL,&#xA;--&#x9;[TypeID] [int] NULL FOREIGN KEY REFERENCES [dbo].[TypesOfServices] (ID),&#xA;--&#x9;[Price] [decimal](18, 0) NULL,&#xA;--&#x9;[d_StatusID] [int] NULL  FOREIGN KEY REFERENCES [dbo].[Status] (ID),&#xA;--&#x9;[EmploeeID] [int] NULL FOREIGN KEY REFERENCES  [dbo].[Employee] (ID),&#xA;--&#x9;[EmailID] [int] NULL FOREIGN KEY REFERENCES  [dbo].[Email] (ID),&#xA;--&#x9;[JobID] [int] NULL FOREIGN KEY REFERENCES  [dbo].[Job] (ID),&#xA;--&#x9;[DLM] [datetime] NOT NULL&#xA;--) ON [PRIMARY]&#xA;--GO&#xA;&#xA;DROP INDEX IXС_FactConvertLeadToDeal_Lead_ID_Deal_ID ON dbo.FactConvertLeadToDeal;&#xA;&#xA;&#xA;TRUNCATE TABLE dbo.[FactConvertLeadToDeal];&#xA;&#xA;-- &#x9;CREATE NONCLUSTERED INDEX IXNС_FactConvertLeadToDeal_CreatedDate&#xA;--&#x9;ON dbo.FactConvertLeadToDeal ([CreatedDate] asc)&#xA;--&#x9;INCLUDE ([Lead_ID], [CustomerID], [RegionID], [StatusID], [SourceID], [Deal_ID], [Deal_DateCreate], [Deal_DateClose], [TypeID], [Price], [d_StatusID], [EmploeeID], [EmailID], [JobID], [DLM])&#xA;&#xA;SELECT dbo.ufnString_agg('dbo', 'FactConvertLeadToDeal')&#xA;&#xA;INSERT  INTO [DWH2021].dbo.FactConvertLeadToDeal&#x9;([Lead_ID], [CreatedDate], [CustomerID], [RegionID], [StatusID], [SourceID], [Deal_ID], [Deal_DateCreate], [Deal_DateClose], [TypeID], [Price], [d_StatusID], [EmploeeID], [EmailID], [JobID], [DLM])&#xA; SELECT&#xA;&#x9;l.[Lead_ID]&#xA;&#x9;,CAST(l.[DateCtreate] as DATE) as [CreatedDate]&#xA;&#x9;,l.[CustomerID]&#xA;&#x9;,c.RegionID&#xA;&#x9;,l.[StatusID]&#xA;&#x9;,l.[SourceID]&#xA;&#x9;,d.[Deal_ID]&#xA;&#x9;,CAST(d.[DateCreate]  as DATE) as [Deal_DateCreate]&#xA;&#x9;,CAST(d.[DateClose]  as DATE) as [Deal_DateClose]&#xA;&#x9;,d.[TypeID]&#xA;&#x9;,p.Price&#xA;&#x9;,d.[StatusID] as [d_StatusID]&#xA;&#x9;,d.[EmploeeID]&#xA;&#x9;,e.EmailID&#xA;&#x9;,e.JobID&#xA;&#x9;,GETDATE() as DLM&#xA; FROM [dbo].[Lead] l -- WITH ( INDEX( [PK__Lead__8C42D7A11000A935] ) )  --- не эффективно &#xA; LEFT HASH JOIN [dbo].[Deal] d   on l.Lead_ID=d.Lead_ID   -- Добавляем HASH, так же результат даёт MERGE&#xA; LEFT  JOIN [dbo].[Customers] c on c.ID=l.CustomerID&#xA; LEFT JOIN [dbo].[Employee] e on e.ID=d.[EmploeeID]&#xA; LEFT JOIN &#x9;[dbo].[TypesOfServices] t on t.ID=d.[TypeID]&#xA; LEFT JOIN &#x9;[dbo].[Price] p on p.ID=t.PriceID&#xA;WHERE l.[DateCtreate] &gt;= N'20200101'; -- убираем функции в условиях&#xA;&#xA;&#xA;&#xA;CREATE UNIQUE CLUSTERED INDEX IXС_FactConvertLeadToDeal_Lead_ID_Deal_ID ON dbo.FactConvertLeadToDeal &#xA;&#x9;(&#xA;&#x9;Lead_ID ASC,&#xA;&#x9;[Deal_ID] ASC&#xA;&#x9;);&#x9;&#xA;&#x9;--ALTER TABLE dbo.Employee CHECK CONSTRAINT [PK__Employee__3214EC2779473C11];  &#xA;&#xA;&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT  FK_FactConvertLeadToDeal_CreatedDate&#x9;FOREIGN KEY (CreatedDate) REFERENCES [dbo].[CalendarDay] ([CreatedDate]);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_CustomerID&#x9;FOREIGN KEY (CustomerID) REFERENCES  [dbo].[Customers] (ID);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_RegionID&#x9;&#x9;FOREIGN KEY (RegionID) REFERENCES  [dbo].[Region] (ID);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_StatusID&#x9;&#x9;FOREIGN KEY (StatusID) REFERENCES  [dbo].[Status] (ID);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_SourceID&#x9;&#x9;FOREIGN KEY (StatusID) REFERENCES  [dbo].[Source] (ID);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_TypeID&#x9;&#x9;FOREIGN KEY (TypeID) REFERENCES  [dbo].[TypesOfServices] (ID);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_d_StatusID&#x9;FOREIGN KEY (d_StatusID) REFERENCES  [dbo].[Status] (ID);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_EmploeeID&#x9;&#x9;FOREIGN KEY (EmploeeID) REFERENCES[dbo].[Employee] (ID);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_EmailID&#x9;&#x9;FOREIGN KEY (EmailID) REFERENCES [dbo].[Email] (ID);&#xA;ALTER TABLE [dbo].[FactConvertLeadToDeal] ADD CONSTRAINT FK_FactConvertLeadToDeal_JobID&#x9;&#x9;&#x9;FOREIGN KEY (JobID) REFERENCES  [dbo].[Job] (ID);&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--В данном разделе CDATA содержатся сведения о макете пакета. В данном разделе содержатся сведения о координатах (x,y), ширине и высоте.-->
<!--В случае возникновения ошибки при редактировании этого раздела вручную его можно удалить. -->
<!--Пакет можно загрузить обычным образом, но прежние сведения о макете будут утеряны, и конструктор автоматически перераспределит элементы в области конструктора.-->
<Objects
  Version="8">
  <!--Все приведенные ниже узлы будут содержать свойства, не влияющие на поведение среды выполнения.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph">
        <NodeLayout
          Size="127,42"
          Id="Package\LoadOLAP"
          TopLeft="54,55" />
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>